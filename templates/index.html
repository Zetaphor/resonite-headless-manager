<!DOCTYPE html>
<html>

<head>
  <title>Resonite Headless Manager</title>
  <meta name="color-scheme" content="dark">
  <meta name="theme-color" content="#1a1a1a">
  <meta name="darkreader-lock">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Roboto:wght@300;400;500;700&display=swap"
    rel="stylesheet">
  <style>
    body {
      background-color: #1a1a1a;
      color: #ffffff;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
    }

    #output {
      width: 100%;
      height: 400px;
      background-color: #1e1e1e;
      color: #ffffff;
      font-family: monospace;
      padding: 10px;
      overflow-y: auto;
      margin-bottom: 10px;
    }

    #command-input {
      width: 80%;
      padding: 8px 12px;
      background-color: #2a2a2a;
      border: 1px solid #3a3a3a;
      color: #ffffff;
      font-family: monospace;
      border-radius: 4px;
    }

    #command-input:focus {
      outline: none;
      border-color: #4CAF50;
    }

    #status {
      margin-bottom: 10px;
      padding: 15px;
      border-radius: 5px;
      font-family: monospace;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
      width: calc(100% - 30px);
    }

    .command-line {
      color: #00ff00;
    }

    .error {
      color: #ff0000;
    }

    #worlds-container {
      margin: 20px 0;
      padding: 15px;
      background-color: #2a2a2a;
      border-radius: 5px;
    }

    #worlds-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 15px;
      padding: 5px;
    }

    .world-card {
      background-color: #3a3a3a;
      padding: 15px;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
      min-width: 400px;
    }

    .world-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .world-card .world-name {
      font-size: 1.1em;
      font-weight: bold;
      color: #4CAF50;
      padding-bottom: 5px;
      border-bottom: 1px solid #4a4a4a;
      margin-bottom: 5px;
    }

    .world-stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #ffffff;
      font-family: monospace;
    }

    .world-stat .label {
      color: #888;
    }

    .world-card span {
      color: #ffffff;
      font-family: monospace;
    }

    .world-card .world-name {
      font-weight: bold;
      color: #4CAF50;
    }

    .worlds-header {
      color: #ffffff;
      margin-bottom: 10px;
      font-size: 1.2em;
      font-weight: 500;
      font-family: 'Roboto', sans-serif;
    }

    .worlds-loading {
      color: #888;
      font-style: italic;
      padding: 10px;
    }

    .no-worlds {
      color: #888;
      padding: 10px;
      text-align: center;
      background-color: #3a3a3a;
      border-radius: 4px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-running {
      background-color: #2a2a2a;
      color: #4CAF50;
    }

    .status-running .status-indicator {
      background-color: #4CAF50;
      box-shadow: 0 0 8px #4CAF50;
    }

    .status-stopped {
      background-color: #2a2a2a;
      color: #f44336;
    }

    .status-stopped .status-indicator {
      background-color: #f44336;
      box-shadow: 0 0 8px #f44336;
    }

    .status-connecting {
      background-color: #2a2a2a;
      color: #ffc107;
    }

    .status-connecting .status-indicator {
      background-color: #ffc107;
      box-shadow: 0 0 8px #ffc107;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      50% {
        opacity: 0.5;
      }
    }

    button {
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: monospace;
      font-weight: bold;
    }

    button:hover {
      background-color: #45a049;
    }

    button:active {
      background-color: #3d8b40;
    }

    .world-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .world-description {
      grid-column: 1 / -1;
      color: #888;
      font-style: italic;
      padding: 5px 0;
      border-top: 1px solid #4a4a4a;
      margin-top: 5px;
    }

    .world-tags {
      grid-column: 1 / -1;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    .tag {
      background-color: #4a4a4a;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.9em;
    }

    .user-list {
      grid-column: 1 / -1;
      margin-top: 10px;
      padding: 10px;
      border-top: 1px solid #3a3a3a;
    }

    .user-list .label {
      display: block;
      margin-bottom: 5px;
    }

    .user-list .users {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-right: 10px;
    }

    .user-list .user {
      background-color: #4CAF50;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.9em;
    }

    .session-id {
      font-family: monospace;
      font-size: 0.8em;
      color: #888;
      word-break: break-all;
      flex-grow: 1;
    }

    .console-section {
      margin-top: 20px;
      display: none;
      /* Hidden by default */
    }

    .toggle-console {
      display: flex;
      align-items: center;
      gap: 8px;
      background: none;
      border: 1px solid #4CAF50;
      padding: 8px 16px;
      color: #4CAF50;
      cursor: pointer;
      transition: all 0.2s;
    }

    .toggle-console:hover {
      background-color: #4CAF5022;
    }

    .toggle-console .icon {
      transition: transform 0.2s;
    }

    .toggle-console.expanded .icon {
      transform: rotate(180deg);
    }

    .console-section #output {
      width: 100%;
      height: 400px;
      background-color: #1e1e1e;
      color: #ffffff;
      font-family: monospace;
      padding: 10px;
      overflow-y: auto;
      margin-bottom: 10px;
    }

    .console-section #command-input {
      width: 80%;
      padding: 8px 12px;
      background-color: #2a2a2a;
      border: 1px solid #3a3a3a;
      color: #ffffff;
      font-family: monospace;
      border-radius: 4px;
    }

    .session-id-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .copy-button {
      background: none;
      border: none;
      color: #4CAF50;
      padding: 2px 6px;
      font-size: 0.8em;
      cursor: pointer;
      opacity: 0.7;
      transition: all 0.2s;
    }

    .copy-button:hover {
      opacity: 1;
      background-color: #4CAF5022;
    }

    .copy-button.copied {
      color: #45a049;
      background-color: #4CAF5044;
    }

    /* Add new styles for config section */
    .config-section {
      margin-top: 20px;
      background-color: #2a2a2a;
      padding: 15px;
      border-radius: 5px;
      display: none;
      /* Hidden by default */
    }

    .config-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    #config-editor {
      width: 100%;
      height: 400px;
      background-color: #1e1e1e;
      color: #ffffff;
      font-family: monospace;
      padding: 10px;
      border: 1px solid #3a3a3a;
      border-radius: 4px;
      resize: vertical;
      white-space: pre;
      overflow-wrap: normal;
      overflow-x: auto;
    }

    .config-actions {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }

    .save-button {
      background-color: #4CAF50;
    }

    .save-button:disabled {
      background-color: #666;
      cursor: not-allowed;
    }

    .error-message {
      color: #ff6b6b;
      margin-top: 10px;
      padding: 10px;
      background-color: #ff6b6b22;
      border-radius: 4px;
      display: none;
    }

    /* Add new styles after existing styles */
    .toggle-buttons {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }

    .toggle-console {
      /* Update toggle button styles */
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toggle-console .icon {
      display: inline-block;
      transition: transform 0.2s;
      transform: rotate(-90deg);
      /* Point right by default */
    }

    .toggle-console.expanded .icon {
      transform: rotate(0deg);
      /* Point down when expanded */
    }

    .layout-container {
      display: flex;
      gap: 20px;
      min-height: 100vh;
    }

    .main-content {
      flex: 1;
    }

    .sidebar {
      width: 300px;
      background-color: #2a2a2a;
      padding: 15px;
      border-radius: 5px;
      height: fit-content;
      position: sticky;
      top: 20px;
    }

    .sidebar-header {
      color: #ffffff;
      margin-bottom: 15px;
      font-size: 1.2em;
      font-weight: bold;
      padding-bottom: 10px;
      border-bottom: 1px solid #3a3a3a;
    }

    .setting-group {
      margin-bottom: 15px;
    }

    .setting-label {
      display: block;
      color: #888;
      margin-bottom: 5px;
    }

    .setting-input {
      width: calc(100% - 16px);
      padding: 8px;
      background-color: #1e1e1e;
      border: 1px solid #3a3a3a;
      color: #ffffff;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .setting-input:focus {
      outline: none;
      border-color: #4CAF50;
    }

    .setting-description {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }

    /* Add these styles in the <style> section */
    .user-card {
      background-color: #2a2a2a;
      border-radius: 4px;
      padding: 8px;
      margin: 5px 0;
      width: calc(100% - 16px);
    }

    .user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .user-name {
      font-weight: bold;
      color: #ffffff;
    }

    .user-role {
      font-size: 0.8em;
      padding: 2px 6px;
      background-color: #4CAF50;
      border-radius: 10px;
      color: white;
    }

    .user-stats {
      display: flex;
      gap: 10px;
      font-size: 0.9em;
      color: #888;
    }

    .user-stat {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-dot.present {
      background-color: #4CAF50;
      box-shadow: 0 0 4px #4CAF50;
    }

    .status-dot.away {
      background-color: #888;
    }

    .user-stat.silenced {
      color: #ff6b6b;
    }

    .user-list {
      grid-column: 1 / -1;
      margin-top: 10px;
      padding: 10px;
      border-top: 1px solid #3a3a3a;
    }

    .user-list .label {
      display: block;
      margin-bottom: 10px;
      color: #888;
    }

    .users {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-right: 10px;
    }

    .last-updated {
      font-size: 0.9em;
      color: #888;
      font-style: italic;
    }

    #output,
    #command-input,
    .session-id,
    .world-stat,
    .user-card {
      font-family: 'Roboto Mono', monospace;
    }

    .worlds-header,
    .sidebar-header {
      color: #ffffff;
      margin-bottom: 10px;
      font-size: 1.2em;
      font-weight: 500;
      font-family: 'Roboto', sans-serif;
    }

    button {
      font-family: 'Roboto', sans-serif;
      font-weight: 500;
    }

    #config-editor {
      font-family: 'Roboto Mono', monospace;
      font-size: 14px;
    }

    .world-card .world-name {
      font-family: 'Roboto', sans-serif;
      font-weight: 500;
    }

    .user-name {
      font-family: 'Roboto', sans-serif;
      font-weight: 500;
    }

    .setting-label {
      font-family: 'Roboto', sans-serif;
      font-weight: 500;
    }

    .setting-description {
      font-family: 'Roboto', sans-serif;
      font-weight: 300;
    }

    @media (max-width: 480px) {
      .world-card {
        min-width: 300px;
      }

      #worlds-list {
        grid-template-columns: 1fr;
      }
    }

    /* Add these new styles and replace existing related styles */
    .footer-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #2a2a2a;
      padding: 8px 20px;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
      z-index: 100;
    }

    .footer-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .overlay-panel {
      position: fixed;
      bottom: 70px;
      /* Height of footer + padding */
      left: 0;
      right: 0;
      background-color: #1a1a1a;
      border-top: 1px solid #3a3a3a;
      display: none;
      z-index: 99;
      height: calc(50vh - 10px);
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
    }

    .panel-content {
      height: 100%;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    /* Console specific styles */
    .console-section .panel-content {
      gap: 10px;
      padding-bottom: 50px;
    }

    .console-section #output {
      flex: 1;
      margin: 0;
    }

    .console-section .input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .console-section #command-input {
      flex: 1;
      margin: 0;
    }

    /* Config section specific styles */
    .config-section .panel-content {
      gap: 15px;
      padding-bottom: 50px;
    }

    .config-section #config-editor {
      flex: 1;
      margin: 0;
      resize: none;
    }

    /* Update main content to account for footer */
    .layout-container {
      padding-bottom: 70px;
      /* Height of footer + some extra space */
    }

    /* Update toggle button styles */
    .toggle-console {
      background: none;
      border: 1px solid #4CAF50;
      color: #4CAF50;
      padding: 6px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9em;
    }

    .toggle-console:hover {
      background-color: #4CAF5022;
    }

    .toggle-console.expanded {
      background-color: #4CAF50;
      color: white;
    }

    .editor-container {
      position: relative;
      flex: 1;
      display: flex;
      background-color: #1e1e1e;
      border: 1px solid #3a3a3a;
      border-radius: 4px;
      overflow: hidden;
    }

    .line-numbers {
      width: 50px;
      padding: 10px 5px;
      background-color: #252525;
      border-right: 1px solid #3a3a3a;
      color: #666;
      font-family: 'Roboto Mono', monospace;
      font-size: 14px;
      text-align: right;
      user-select: none;
      line-height: 1.5;
      overflow: hidden;
    }

    /* Remove white-space: pre from line numbers */
    .line-numbers div {
      padding-right: 8px;
    }

    #config-editor {
      flex: 1;
      margin: 0;
      border: none;
      border-radius: 0 4px 4px 0;
      padding: 10px;
      line-height: 1.5;
      white-space: pre;
      overflow-y: scroll;
      overflow-x: auto;
      resize: none;
      position: relative;
      z-index: 1;
      background: transparent;
    }

    #config-editor-highlight {
      position: absolute;
      left: 60px;
      /* Width of line numbers + padding */
      right: 0;
      height: 21px;
      /* Should match line-height */
      background-color: #2d2d2d;
      pointer-events: none;
      z-index: 0;
      /* transition: top 0.1s; */
    }

    /* Add these styles in the <style> section, near the editor styles */
    .editor-container {
      /* ... existing styles ... */
    }

    /* Add these new styles */
    #config-editor {
      /* ... existing styles ... */
      caret-color: #fff;
      /* Makes cursor visible */
    }

    /* Style for the current line highlight */
    #config-editor-highlight {
      position: absolute;
      width: 100%;
      background-color: #2d2d2d;
      pointer-events: none;
      z-index: 0;
    }

    /* Ensure editor content stays above highlight */
    #config-editor {
      position: relative;
      z-index: 1;
      background: transparent;
    }

    /* Update line numbers container to accommodate highlight */
    .line-numbers {
      /* ... existing styles ... */
      position: relative;
      z-index: 1;
    }

    /* Add style for highlighted line number */
    .line-numbers .current-line {
      color: #fff;
      background-color: #2d2d2d;
    }
  </style>
</head>

<body>
  <div id="status" class="status-connecting">
    <span class="status-indicator"></span>
    <span class="status-text">Connecting...</span>
    <span class="last-updated">Last updated: Never</span>
  </div>

  <div class="layout-container">
    <div class="main-content">
      <div id="worlds-container">
        <div class="worlds-header">Active Worlds</div>
        <div id="worlds-list">
          <div class="worlds-loading">Loading worlds...</div>
        </div>
      </div>
    </div>

    <div class="sidebar">
      <div class="sidebar-header">Settings</div>
      <div class="setting-group">
        <label class="setting-label" for="refresh-interval">World Refresh Interval</label>
        <input type="number" id="refresh-interval" class="setting-input" value="30" min="10">
        <div class="setting-description">
          How often to refresh the worlds list (in seconds)
        </div>
      </div>
    </div>
  </div>

  <div class="footer-bar">
    <div class="footer-buttons">
      <button class="toggle-console" onclick="toggleConsole()">
        <span class="icon">â–¼</span>
        <span>Console</span>
      </button>
      <button class="toggle-console" onclick="toggleConfig()">
        <span class="icon">â–¼</span>
        <span>Config Editor</span>
      </button>
    </div>
  </div>

  <div class="overlay-panel console-section">
    <div class="panel-content">
      <div id="output"></div>
      <div class="input-group">
        <input type="text" id="command-input" placeholder="Enter command...">
        <button onclick="sendCommand()">Send</button>
      </div>
    </div>
  </div>

  <div class="overlay-panel config-section">
    <div class="panel-content">
      <div class="config-header">
        <h3>Headless Config</h3>
        <div class="config-actions">
          <button onclick="formatConfig()">Format JSON</button>
          <button class="save-button" onclick="saveConfig()">Save Changes</button>
        </div>
      </div>
      <div class="editor-container">
        <div class="line-numbers" id="line-numbers"></div>
        <textarea id="config-editor" spellcheck="false"></textarea>
      </div>
      <div class="error-message"></div>
    </div>
  </div>

  <script>
    let ws;
    const output = document.getElementById('output');
    const commandInput = document.getElementById('command-input');
    const statusDiv = document.getElementById('status');

    function connect() {
      ws = new WebSocket(`ws://${window.location.host}/ws`);

      ws.onopen = function () {
        const statusDiv = document.getElementById('status');
        const statusText = statusDiv.querySelector('.status-text');
        statusDiv.classList.remove('status-connecting', 'status-running', 'status-stopped');
        statusDiv.classList.add('status-connecting');
        statusText.textContent = 'Connected - Checking Status...';

        // Request initial status and worlds
        ws.send(JSON.stringify({ type: 'get_status' }));
        ws.send(JSON.stringify({ type: 'get_worlds' }));

        // Set up periodic status updates with the configurable interval
        refreshTimer = setInterval(() => {
          if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'get_status' }));
            ws.send(JSON.stringify({ type: 'get_worlds' }));
          }
        }, refreshInterval);
      };

      ws.onclose = function () {
        const statusDiv = document.getElementById('status');
        const statusText = statusDiv.querySelector('.status-text');
        statusDiv.classList.remove('status-connecting', 'status-running', 'status-stopped');
        statusDiv.classList.add('status-connecting');
        statusText.textContent = 'Disconnected - Reconnecting...';
        setTimeout(connect, 1000);
      };

      ws.onmessage = function (event) {
        let data;
        try {
          // First try to parse as regular JSON
          if (typeof event.data === 'string') {
            data = JSON.parse(event.data);
          }
          // If it's a blob, handle it asynchronously
          else if (event.data instanceof Blob) {
            // event.data.text().then(text => {
            //   try {
            //     data = JSON.parse(text);
            //     handleMessage(data);
            //   } catch (e) {
            //     console.error('Failed to parse blob data:', e);
            //     appendOutput(`Error: Failed to parse server message - ${e.message}`, 'error');
            //   }
            // });
            return;
          }
          // Handle the parsed data
          if (data) {
            handleMessage(data);
          }
        } catch (e) {
          console.error('Failed to parse message:', e);
          appendOutput(`Error: Failed to parse server message - ${e.message}`, 'error');
        }
      };
    }

    function sendCommand() {
      const command = commandInput.value.trim();
      if (command) {
        ws.send(JSON.stringify({
          type: 'command',
          command: command
        }));
        appendOutput(`${command}`, 'command-line');
        commandInput.value = '';
      }
    }

    function appendOutput(text, className = '') {
      const div = document.createElement('div');
      div.textContent = text;
      if (className) {
        div.className = className;
      }
      output.appendChild(div);
      output.scrollTop = output.scrollHeight;
    }

    function updateStatus(status) {
      const statusDiv = document.getElementById('status');
      const statusText = statusDiv.querySelector('.status-text');
      const lastUpdated = statusDiv.querySelector('.last-updated');

      // Update last-updated timestamp
      const now = new Date();
      const timeString = now.toLocaleTimeString();
      lastUpdated.textContent = `Last updated: ${timeString}`;

      // Remove all existing status classes
      statusDiv.classList.remove('status-connecting', 'status-running', 'status-stopped');

      if (status.error) {
        statusDiv.classList.add('status-stopped');
        statusText.textContent = `Error - ${status.error}`;
        return;
      }

      switch (status.status.toLowerCase()) {
        case 'running':
          statusDiv.classList.add('status-running');
          break;
        case 'stopped':
        case 'exited':
          statusDiv.classList.add('status-stopped');
          break;
        default:
          statusDiv.classList.add('status-connecting');
      }

      statusText.textContent = `${status.status} (${status.name})`;
    }

    function updateWorlds(worlds) {
      const worldsList = document.getElementById('worlds-list');
      worldsList.innerHTML = ''; // Clear existing worlds

      if (!worlds || worlds.length === 0) {
        const noWorldsDiv = document.createElement('div');
        noWorldsDiv.className = 'no-worlds';
        noWorldsDiv.textContent = 'No active worlds found';
        worldsList.appendChild(noWorldsDiv);
        return;
      }

      worlds.forEach(world => {
        const worldDiv = document.createElement('div');
        worldDiv.className = 'world-card';

        // Create tags HTML if tags exist
        const tagsHtml = world.tags ?
          `<div class="world-tags">
            ${world.tags.split(',').map(tag => `<span class="tag">${tag.trim()}</span>`).join('')}
           </div>` : '';

        // Create users list HTML if users exist
        const usersHtml = world.users_list && world.users_list.length > 0 ?
          `<div class="user-list">
            <span class="label">Connected Users:</span>
            <div class="users">
              ${world.users_list.map(user => `
                <div class="user-card">
                  <div class="user-header">
                    <span class="user-name">${user.username}</span>
                    <span class="user-role">${user.role}</span>
                  </div>
                  <div class="user-stats">
                    <span class="user-stat" title="Present Status">
                      <i class="status-dot ${user.present ? 'present' : 'away'}"></i>
                      ${user.present ? 'Present' : 'Away'}
                    </span>
                    <span class="user-stat" title="Ping">
                      ${user.ping}ms
                    </span>
                    <span class="user-stat" title="FPS">
                      ${user.fps.toFixed(1)} FPS
                    </span>
                    ${user.silenced ? '<span class="user-stat silenced" title="User is silenced">ðŸ”‡</span>' : ''}
                  </div>
                </div>
              `).join('')}
            </div>
           </div>` : '';

        worldDiv.innerHTML = `
          <span class="world-name">${world.name}</span>
          <div class="session-id-container">
            <div class="session-id">Session: ${world.sessionId}</div>
            <button
              class="copy-button"
              onclick="copyToClipboard('${world.sessionId}')"
              data-session-id="${world.sessionId}">
              Copy
            </button>
          </div>
          <div class="world-details">
            <div class="world-stat">
              <span class="label">Users:</span>
              <span>${world.users}/${world.maxUsers}</span>
            </div>
            <div class="world-stat">
              <span class="label">Present:</span>
              <span>${world.present}</span>
            </div>
            <div class="world-stat">
              <span class="label">Access:</span>
              <span>${world.accessLevel}</span>
            </div>
            <div class="world-stat">
              <span class="label">Uptime:</span>
              <span>${world.uptime}</span>
            </div>
            <div class="world-stat">
              <span class="label">Hidden:</span>
              <span>${world.hidden ? 'Yes' : 'No'}</span>
            </div>
            <div class="world-stat">
              <span class="label">Mobile:</span>
              <span>${world.mobileFriendly ? 'Yes' : 'No'}</span>
            </div>
            ${world.description ?
            `<div class="world-description">${world.description}</div>` : ''}
            ${tagsHtml}
            ${usersHtml}
          </div>
        `;

        worldsList.appendChild(worldDiv);
      });
    }

    // Handle Enter key in input
    commandInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        sendCommand();
      }
    });

    // Initial connection
    connect();

    function toggleConsole() {
      const consoleSection = document.querySelector('.console-section');
      const toggleButton = document.querySelector('.toggle-console:nth-of-type(1)');
      const isExpanded = consoleSection.style.display === 'block';

      // Close config panel if open
      const configSection = document.querySelector('.config-section');
      const configButton = document.querySelector('.toggle-console:nth-of-type(2)');
      configSection.style.display = 'none';
      configButton.classList.remove('expanded');

      consoleSection.style.display = isExpanded ? 'none' : 'block';
      toggleButton.classList.toggle('expanded', !isExpanded);

      if (!isExpanded) {
        const input = document.getElementById('command-input');
        input.focus();
      }
    }

    function toggleConfig() {
      const configSection = document.querySelector('.config-section');
      const toggleButton = document.querySelector('.toggle-console:nth-of-type(2)');
      const isExpanded = configSection.style.display === 'block';

      // Close console panel if open
      const consoleSection = document.querySelector('.console-section');
      const consoleButton = document.querySelector('.toggle-console:nth-of-type(1)');
      consoleSection.style.display = 'none';
      consoleButton.classList.remove('expanded');

      configSection.style.display = isExpanded ? 'none' : 'block';
      toggleButton.classList.toggle('expanded', !isExpanded);

      if (!isExpanded && !currentConfig) {
        loadConfig();
      }
    }

    function copyToClipboard(sessionId) {
      // Check if the Clipboard API is supported
      if (!navigator.clipboard) {
        // Fallback for browsers that don't support the Clipboard API
        const textArea = document.createElement('textarea');
        textArea.value = sessionId;
        textArea.style.position = 'fixed';  // Avoid scrolling to bottom
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          document.execCommand('copy');
          const button = document.querySelector(`[data-session-id="${sessionId}"]`);
          button.textContent = 'Copied!';
          button.classList.add('copied');

          setTimeout(() => {
            button.textContent = 'Copy';
            button.classList.remove('copied');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy text: ', err);
        }

        document.body.removeChild(textArea);
        return;
      }

      // Use Clipboard API if available
      navigator.clipboard.writeText(sessionId)
        .then(() => {
          const button = document.querySelector(`[data-session-id="${sessionId}"]`);
          button.textContent = 'Copied!';
          button.classList.add('copied');

          setTimeout(() => {
            button.textContent = 'Copy';
            button.classList.remove('copied');
          }, 2000);
        })
        .catch(err => {
          console.error('Failed to copy text: ', err);
        });
    }

    let currentConfig = null;

    async function loadConfig() {
      try {
        const response = await fetch('/config');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const config = await response.json();
        currentConfig = config;

        const editor = document.getElementById('config-editor');
        editor.value = JSON.stringify(config, null, 2);
        updateLineNumbers();
        updateLineHighlight();
        hideError();
      } catch (error) {
        showError(`Failed to load config: ${error.message}`);
      }
    }

    async function saveConfig() {
      const editor = document.getElementById('config-editor');
      try {
        // Validate JSON
        const config = JSON.parse(editor.value);

        // Send to server
        const response = await fetch('/config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(config)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Failed to save config');
        }

        currentConfig = config;
        hideError();
        showSuccess();
      } catch (error) {
        showError(`Invalid JSON: ${error.message}`);
      }
    }

    function formatConfig() {
      const editor = document.getElementById('config-editor');
      try {
        const config = JSON.parse(editor.value);
        editor.value = JSON.stringify(config, null, 2);
        updateLineNumbers();
        hideError();
      } catch (error) {
        showError(`Invalid JSON: ${error.message}`);
      }
    }

    function showError(message) {
      const errorDiv = document.querySelector('.error-message');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      errorDiv.style.backgroundColor = '#ff6b6b22';
      errorDiv.style.color = '#ff6b6b';
    }

    function showSuccess() {
      const errorDiv = document.querySelector('.error-message');
      errorDiv.textContent = 'Config saved successfully!';
      errorDiv.style.display = 'block';
      errorDiv.style.backgroundColor = '#4CAF5022';
      errorDiv.style.color = '#4CAF50';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 3000);
    }

    function hideError() {
      const errorDiv = document.querySelector('.error-message');
      errorDiv.style.display = 'none';
    }

    let refreshInterval = 30 * 1000; // Default 30 seconds
    let refreshTimer = null;

    function updateRefreshInterval() {
      console.log('updateRefreshInterval');
      const input = document.getElementById('refresh-interval');
      const newInterval = Math.max(5, Math.min(60, parseInt(input.value))) * 1000;

      if (refreshInterval !== newInterval) {
        refreshInterval = newInterval;

        // Clear existing timer
        if (refreshTimer) {
          clearInterval(refreshTimer);
        }

        // Set up new timer
        refreshTimer = setInterval(() => {
          if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'get_status' }));
            ws.send(JSON.stringify({ type: 'get_worlds' }));
          }
        }, refreshInterval);
      }
    }

    // Add event listener for the refresh interval input
    document.getElementById('refresh-interval').addEventListener('change', updateRefreshInterval);
    document.getElementById('refresh-interval').addEventListener('input', updateRefreshInterval);

    // Move the message handling logic to a separate function
    function handleMessage(data) {
      switch (data.type) {
        case 'container_output':
          appendOutput(data.output);
          break;
        case 'command_response':
          console.log('command_response', data.output);
          break;
        case 'status_update':
          updateStatus(data.status);
          break;
        case 'worlds_update':
          updateWorlds(data.output);
          break;
        case 'error':
          console.log('error', data.message);
          appendOutput(`Error: ${data.message}`, 'error');
          break;
        default:
          console.warn('Unknown message type:', data.type);
      }
    }

    function updateLineNumbers() {
      const editor = document.getElementById('config-editor');
      const lineNumbers = document.getElementById('line-numbers');
      const lines = editor.value.split('\n');
      const numbers = lines.map((_, i) => `${(i + 1).toString().padStart(3)}`).join('\n');
      lineNumbers.textContent = numbers;
    }

    // Add event listeners for the config editor
    document.getElementById('config-editor').addEventListener('input', () => {
      updateLineNumbers();
      updateLineHighlight();
    });

    document.getElementById('config-editor').addEventListener('keyup', updateLineHighlight);
    document.getElementById('config-editor').addEventListener('click', updateLineHighlight);
    document.getElementById('config-editor').addEventListener('scroll', function () {
      document.getElementById('line-numbers').scrollTop = this.scrollTop;
      const highlight = document.getElementById('config-editor-highlight');
      if (highlight) {
        highlight.style.transform = `translateY(-${this.scrollTop}px)`;
      }
    });

    // Update the loadConfig function to initialize the highlight
    async function loadConfig() {
      try {
        const response = await fetch('/config');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const config = await response.json();
        currentConfig = config;

        const editor = document.getElementById('config-editor');
        editor.value = JSON.stringify(config, null, 2);
        updateLineNumbers();
        updateLineHighlight();
        hideError();
      } catch (error) {
        showError(`Failed to load config: ${error.message}`);
      }
    }

    function updateLineHighlight() {
      const editor = document.getElementById('config-editor');
      const lineNumbers = document.getElementById('line-numbers');
      const lineHeight = 21; // Fixed line height to match CSS

      // Get cursor position
      const cursorPosition = editor.selectionStart;
      const lines = editor.value.substr(0, cursorPosition).split('\n');
      const currentLineNumber = lines.length;

      // Update line numbers highlight
      const lineNumberElements = editor.value.split('\n')
        .map((_, i) => `<div class="${i + 1 === currentLineNumber ? 'current-line' : ''}">${(i + 1).toString().padStart(3)}</div>`)
        .join('');
      lineNumbers.innerHTML = lineNumberElements;

      // Update editor line highlight
      let highlight = document.getElementById('config-editor-highlight');
      if (!highlight) {
        highlight = document.createElement('div');
        highlight.id = 'config-editor-highlight';
        editor.parentElement.insertBefore(highlight, editor);
      }

      highlight.style.top = `${(currentLineNumber - 1) * lineHeight + 10}px`; // Add padding offset
    }
  </script>
</body>

</html>